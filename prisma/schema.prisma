generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String             @id @default(cuid())
  email              String             @unique
  password           String?
  name               String?
  image              String?
  role               UserRole           @default(MEMBER)
  hierarchyLevel     HierarchyLevel?    @default(RF1)
  isActive           Boolean            @default(true)
  emailVerified      DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  contactNumber      String?
  customDepartment   String?
  customDivision     String?
  customSection      String?
  customTeam         String?
  department         String?
  division           String?
  firstName          String?
  isLeader           Boolean            @default(false)
  jobLevel           String?
  lastName           String?
  middleName         String?
  organizationalPath String?
  positionTitle      String?
  reportsToId        String?
  section            String?
  sectorHeadInitials String?
  shortName          String?
  team               String?
  username           String             @unique
  accounts           Account[]
  activities         Activity[]
  comments           Comment[]
  commentReactions   CommentReaction[]
  events             Event[]
  sessions           Session[]
  taskCollaborators  TaskCollaborator[] @relation("TaskCollaborators")
  taskTeamMembers    TaskTeamMember[]   @relation("TaskTeamMembers")
  assignedTasks2     Task[]             @relation("TaskAssignedBy")
  assignedTasks      Task[]             @relation("TaskAssignee")
  createdTasks       Task[]             @relation("TaskCreator")
  teamMembers        TeamMember[]
  ossbRequests       OSSBRequest[]
  reportsTo          User?              @relation("UserReportsTo", fields: [reportsToId], references: [id])
  subordinates       User[]             @relation("UserReportsTo")

  @@map("users")
}

model Admin {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admins")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Team {
  id          String       @id @default(cuid())
  name        String
  description String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  events      Event[]
  tasks       Task[]
  members     TeamMember[]

  @@map("teams")
}

model TeamMember {
  id       String         @id @default(cuid())
  userId   String
  teamId   String
  role     TeamMemberRole @default(MEMBER)
  joinedAt DateTime       @default(now())
  team     Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@map("team_members")
}

model Task {
  id                    String             @id @default(cuid())
  title                 String
  description           String?
  status                TaskStatus         @default(TODO)
  priority              Priority           @default(MEDIUM)
  dueDate               DateTime?
  startDate             DateTime?
  assigneeId            String?
  creatorId             String
  teamId                String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  assignedById          String?
  progressPercentage    Int                @default(0)
  taskType              TaskType           @default(INDIVIDUAL)
  googleCalendarId      String?
  googleCalendarEventId String?
  syncedAt              DateTime?
  // New Google Calendar-compatible fields
  location              String?            // Physical location or address (e.g., "Conference Room A", "123 Main St")
  meetingLink           String?            // Virtual meeting link (e.g., Google Meet, Zoom, Teams)
  allDay                Boolean            @default(false) // All-day task flag
  recurrence            String?            // Recurrence rule (RRULE format)
  reminders             Json?              // Notification reminders in JSON format
  // Relations
  comments              Comment[]
  events                Event[]
  collaborators         TaskCollaborator[]
  teamMembers           TaskTeamMember[]
  assignedBy            User?              @relation("TaskAssignedBy", fields: [assignedById], references: [id])
  assignee              User?              @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator               User               @relation("TaskCreator", fields: [creatorId], references: [id])
  team                  Team?              @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("tasks")
}

model TaskTeamMember {
  id        String         @id @default(cuid())
  taskId    String
  userId    String
  role      TaskMemberRole @default(MEMBER)
  createdAt DateTime       @default(now())
  task      Task           @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User           @relation("TaskTeamMembers", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@map("task_team_members")
}

model TaskCollaborator {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation("TaskCollaborators", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@map("task_collaborators")
}

model Comment {
  id        String            @id @default(cuid())
  content   String
  taskId    String
  authorId  String
  parentId  String?
  imageUrl  String?           // Legacy: kept for backward compatibility
  fileUrl   String?           // URL to file in OSS
  fileName  String?           // Original filename
  fileType  String?           // MIME type
  fileSize  Int?              // Size in bytes
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  author    User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  task      Task              @relation(fields: [taskId], references: [id], onDelete: Cascade)
  parent    Comment?          @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[]         @relation("CommentReplies")
  reactions CommentReaction[]

  @@map("comments")
}

model CommentReaction {
  id        String   @id @default(cuid())
  emoji     String
  commentId String
  userId    String
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId, emoji])
  @@map("comment_reactions")
}

model Event {
  id                 String    @id @default(cuid())
  title              String
  description        String?
  startTime          DateTime
  endTime            DateTime
  allDay             Boolean   @default(false)
  color              String?
  type               EventType @default(MEETING)
  creatorId          String
  teamId             String?
  taskId             String?
  googleCalendarId   String?
  googleCalendarEventId String?
  syncedAt           DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  creator            User      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  task               Task?     @relation(fields: [taskId], references: [id])
  team               Team?     @relation(fields: [teamId], references: [id])

  @@map("events")
}

model Activity {
  id          String       @id @default(cuid())
  type        ActivityType
  description String
  userId      String
  entityId    String?
  entityType  String?
  metadata    Json?
  createdAt   DateTime     @default(now())
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("activities")
}

model OrganizationalUnit {
  id                String                 @id @default(cuid())
  name              String
  code              String?
  unitType          OrganizationalUnitType
  level             Int
  parentId          String?
  path              String
  metadata          Json?
  isActive          Boolean                @default(true)
  allowsCustomInput Boolean                @default(false)
  requiresCode      Boolean                @default(false)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  parent            OrganizationalUnit?    @relation("UnitHierarchy", fields: [parentId], references: [id])
  children          OrganizationalUnit[]   @relation("UnitHierarchy")

  @@unique([name, parentId])
  @@map("organizational_units")
}

model OrganizationTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  structure   Json
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("organization_templates")
}

model Division {
  id          String       @id @default(cuid())
  name        String       @unique
  code        String?      @unique
  description String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  departments Department[]

  @@map("divisions")
}

model Department {
  id         String    @id @default(cuid())
  name       String
  code       String?
  divisionId String
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  division   Division  @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  sections   Section[]

  @@unique([name, divisionId])
  @@map("departments")
}

model Section {
  id           String      @id @default(cuid())
  name         String
  code         String?
  departmentId String
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  department   Department  @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  teamLabels   TeamLabel[]

  @@unique([name, departmentId])
  @@map("sections")
}

model TeamLabel {
  id        String   @id @default(cuid())
  name      String
  code      String?
  sectionId String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  section   Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([name, sectionId])
  @@map("team_labels")
}

model SectorHead {
  id          String   @id @default(cuid())
  initials    String   @unique
  fullName    String
  description String?
  divisionId  String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("sector_heads")
}

model JobLevel {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("job_levels")
}

model AdminSettings {
  id                       String         @id @default(cuid())
  systemName               String         @default("GCGC Team Management System")
  systemDescription        String?
  allowUserRegistration    Boolean        @default(true)
  requireEmailVerification Boolean        @default(false)
  defaultUserRole          UserRole       @default(MEMBER)
  defaultHierarchyLevel    HierarchyLevel @default(RF1)
  sessionTimeout           Int            @default(60)
  maxLoginAttempts         Int            @default(3)
  enableNotifications      Boolean        @default(true)
  enableAuditLogging       Boolean        @default(true)
  maintenanceMode          Boolean        @default(false)
  maintenanceMessage       String?
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt

  @@map("admin_settings")
}

model CalendarSyncSettings {
  id                      String              @id @default(cuid())
  userId                  String              @unique
  isEnabled               Boolean             @default(false)
  googleCalendarId        String?
  syncDirection           CalendarSyncDirection @default(BOTH)
  syncTaskDeadlines       Boolean             @default(true)
  syncTeamEvents          Boolean             @default(true)
  syncPersonalEvents      Boolean             @default(true)
  googleAccessToken       String?
  googleRefreshToken      String?
  googleTokenExpiry       DateTime?
  webhookChannelId        String?
  webhookResourceId       String?
  webhookExpiration       DateTime?
  lastSyncedAt            DateTime?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  @@map("calendar_sync_settings")
}

// Tracks per-user calendar events for tasks (allows multiple users to have the same task in their calendars)
model UserTaskCalendarSync {
  id                    String   @id @default(cuid())
  userId                String
  taskId                String
  googleCalendarId      String
  googleCalendarEventId String
  syncedAt              DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([userId, taskId])
  @@map("user_task_calendar_syncs")
}

enum UserRole {
  ADMIN
  LEADER
  MEMBER
}

enum HierarchyLevel {
  RF1
  RF2
  RF3
  OF1
  OF2
  M1
  M2
}

enum TeamMemberRole {
  LEADER
  MEMBER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskType {
  INDIVIDUAL
  TEAM
  COLLABORATION
}

enum TaskMemberRole {
  LEADER
  MEMBER
}

enum EventType {
  MEETING
  DEADLINE
  REMINDER
  MILESTONE
  PERSONAL
}

enum ActivityType {
  TASK_CREATED
  TASK_UPDATED
  TASK_COMPLETED
  TASK_ASSIGNED
  COMMENT_ADDED
  TEAM_JOINED
  TEAM_LEFT
  EVENT_CREATED
  EVENT_UPDATED
  LOGIN
}

enum OrganizationalUnitType {
  DIVISION
  DEPARTMENT
  SECTION
  TEAM
  CUSTOM
}

enum CalendarSyncDirection {
  TMS_TO_GOOGLE
  GOOGLE_TO_TMS
  BOTH
}

model OSSBRequest {
  id                    String              @id @default(cuid())
  referenceNo           String              @unique @default(cuid())

  // Section 1: Header Information
  branchOrDepartment    String
  objectiveTitle        String
  versionNo             String?
  partOfAnnualPlan      Boolean             @default(false)

  // Section 2: Project Information
  mipClassification     MIPClassification
  kraOrCpaNumber        Int?
  projectNumber         Int?
  kraOrCpaName          String?
  titleObjective        String
  startDate             DateTime
  endDate               DateTime

  // Section 3: Specific Standards / Success Measures (up to 4)
  successMeasures       Json                // Array of success measure strings

  // Section 4: Program Steps (dynamic/repeatable)
  programSteps          OSSBProgramStep[]
  totalBudget           Float               @default(0)

  // Section 5: Signatories
  preparedBy            String?
  preparedByPosition    String?
  datePrepared          DateTime?
  endorsedBy            String?
  endorsedByPosition    String?
  dateEndorsed          DateTime?
  recommendedBy         String?
  recommendedByPosition String?
  dateRecommended       DateTime?
  approvedBy            String?
  approvedByPosition    String?
  dateApproved          DateTime?

  // Section 6: Attachments / Supporting Documents
  hasGuidelines         Boolean             @default(false)
  hasComputationValue   Boolean             @default(false)
  otherAttachments      String?
  attachments           OSSBAttachment[]

  // Section 7: CC / Remarks
  ccRecipients          String?
  remarks               String?

  // Meta fields
  status                OSSBStatus          @default(DRAFT)
  creatorId             String
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  submittedAt           DateTime?

  creator               User                @relation(fields: [creatorId], references: [id])

  @@map("ossb_requests")
}

model OSSBProgramStep {
  id                    String              @id @default(cuid())
  ossbRequestId         String
  stepNumber            Int
  description           String
  responsiblePerson     String
  deadline              DateTime
  budget                Float               @default(0)
  createdAt             DateTime            @default(now())

  ossbRequest           OSSBRequest         @relation(fields: [ossbRequestId], references: [id], onDelete: Cascade)

  @@map("ossb_program_steps")
}

model OSSBAttachment {
  id                    String              @id @default(cuid())
  ossbRequestId         String
  fileName              String
  fileUrl               String
  fileSize              Int
  fileType              String
  uploadedAt            DateTime            @default(now())

  ossbRequest           OSSBRequest         @relation(fields: [ossbRequestId], references: [id], onDelete: Cascade)

  @@map("ossb_attachments")
}

enum MIPClassification {
  MAINTENANCE
  IMPROVEMENT
  PROJECT
}

enum OSSBStatus {
  DRAFT
  SUBMITTED
  ENDORSED
  RECOMMENDED
  APPROVED
  REJECTED
}
